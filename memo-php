<!doctype html>
<html lang="ja">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<!-- <link rel="stylesheet" href="./css/style.css"> -->

<title>メモ</title>
</head>
<body>
<header>
<h1 class="font-weight-normal">メモ</h1>    
</header>

<main>
<h2></h2>

<!-- ここにプログラムを記述します -->
<?php
  require_once('dbconnect.php');

  if(isset($_REQUEST['page']) && is_numeric($_REQUEST['page'])){
    $page = $_REQUEST['page'];
  } else{
    $page = 1;//page指定がなければpage=1を自動的に入れる様にする
  }

  
  $start = 5 * ($page - 1);
  //page=2のときに次の5件が表示されるように?に5,10,15ずつ入るよう5*($page - 1);としている


  $memos = $db->prepare('SELECT * FROM memos ORDER BY id DESC LIMIT ?,5');
  $memos->bindParam(1,$start,PDO::PARAM_INT);//PDO::PARAM_INTは数字で値を渡せる様になる
  $memos ->execute();//?の場合execute(array($_REQUEST))は型を指定できない為使えない

  // $count = $db->exec('INSERT INTO my_items SET maker_id=1,item_name="もも",
  // price=210,keyword="缶詰,ピンク,甘い"');
  // //execメソッドでSQLを発行、影響を与えた行の数を表す
  // echo $count . '件のデータを挿入しました';

  // $records = $db->query('SELECT * FROM my_items');
  // //queryはデータベースの値を取り出す、select構文の得られた値を受け取る
  // //$recordsはオブジェクトのインスタンスになる->record setのインスタンス
  // //実行に成功したSELECTステートメントにより返されたレコードセットで反復処理が可能であることです。
  // while ($record = $records->fetch()){//$recordは連想配列
  //   echo $record['item_name'] . "\n"; 
  // }
?>
<article>
<a href="input.html">登録する</a>

    <?php while($memo = $memos->fetch()):
      //fetchメソッドは$memosから一件ずつ取り出す
      ?>
      
    <p><a href="memo.php?id=<?php echo $memo['id'];?>"><?php echo mb_substr($memo['memo'],0, 50);
    //mb_strstr()は三つの値をとる、一つ目は元となる文字列、二つ目が開始位置、三つ目は文字数
    //0,50は最初から50文字だけ切り取って表示する
    ?></a></p>
    
    <time><?php echo $memo['created_at'];?></time>
    <hr>
    <?php endwhile; ?>
    
    <?php if($page >=2):?>
      <a href="index.php?page=<?php echo($page-1);?>"><?php echo $page-1;?>ページ目へ</a>
    <?php endif;?>
    |
    <?php $counts = $db->query('SELECT COUNT(*) as cnt FROM memos');
    //countはデータの件数を取得する COUNTのままだと扱いにくいのでasで別名をつけている
    $count = $counts->fetch();//一件しかデータが返ってこない為fetch()で取得
    $max_page = ceil($count['cnt']/5);
    //ceil=切り上げる 1/5=0,2->1...,6/5=1,2->2..,11/5=2,2->3
    if($page < $max_page):
     ?>
    
    <a href="index.php?page=<?php echo $page+1;?>"><?php echo $page+1;?>ページ目へ</a>
    <?php endif;?>

</article>
</main>
</body>    
</html>
